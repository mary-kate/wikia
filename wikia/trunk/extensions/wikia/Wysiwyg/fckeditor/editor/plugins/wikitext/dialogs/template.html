<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>Template Editor</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="robots" content="noindex, nofollow" />
	<script src="../../../dialog/common/fck_dialog_common.js" type="text/javascript"></script>
	<script type="text/javascript">
var dialog	= window.parent ;
var oEditor = dialog.InnerDialogLoaded() ;

var FCK			= oEditor.FCK ;
var FCKLang		= oEditor.FCKLang ;
var FCKConfig	= oEditor.FCKConfig ;
var FCKRegexLib	= oEditor.FCKRegexLib ;
var FCKTools	= oEditor.FCKTools ;

var currentStep = false;

// store refid
var origRefid = FCK.TemplateWizard.refid;

// load wikibits, MW suggest and some of wgFoo JS variables
window.wgMWSuggestTemplate = window.parent.parent.wgMWSuggestTemplate;
window.wgSearchNamespaces = window.parent.parent.wgSearchNamespaces;
window.wgDBname = window.parent.parent.wgDBname;
window.stylepath = window.parent.parent.stylepath;
window.wgContentLanguage = window.parent.wgContentLanguage;
window.sajax_init_object = window.parent.parent.sajax_init_object;

// search only in NS_TEMPLATE (#10)
window.wgSearchNamespaces = [10];

document.write( '<scr' + 'ipt type="text/javascript" src="' + dialog.parent.stylepath + '/common/wikibits.js?' + FCKConfig.StyleVersion + '"><\/scr' + 'ipt>' ) ;
document.write( '<scr' + 'ipt type="text/javascript" src="' + dialog.parent.stylepath + '/common/mwsuggest.js?' + FCKConfig.StyleVersion + '"><\/scr' + 'ipt>' ) ;

document.write('<li' + 'nk rel="stylesheet" type="text/css" href="' + dialog.parent.stylepath + '/common/shared.css?' + FCKConfig.StyleVersion + '"/>');

window.onload = function() {

	dialog.SetAutoSize(true);

	// choose correct editor step
	FCK.log(FCK.TemplateWizard);

	// show step 2 for:
	// * templates existing within article and with parameters
	// * templates to be inserted into article and with parameters
	if (FCK.TemplateWizard.name && FCK.TemplateWizard.params) {
		SelectStep(2);
	}
	else {
		SelectStep(1);
	}

	FCK.Track('/templateEditor/open');
}

function InsertTemplateFromSearch() {
	var templateName = GetE('templateQuery').value;
	var suggestData = window.os_map.templateQuery;

	FCK.log('user typed >>' + templateName + '<< as template name');
	FCK.log(suggestData);

	// only allow template names from suggest results
	if ( suggestData.results && suggestData.results.indexOf(templateName) != -1 ) {
		// send AJAX query to get template parameters
		dialog.Throbber.Show();
		
		var callback = {
			success: function(o) {
				var params = this.FCK.YAHOO.Tools.JSONParse(o.responseText);

				// go to step #2
				this.FCK.log('suggested template: ' + o.argument.templateName);
				this.FCK.log(params);

				this.dialog.Throbber.Hide();
				this.SelectTemplate(o.argument.templateName, params);
			},

			failure: function(o) {},

			scope: window,

			argument: {'templateName': templateName}
		};

		FCK.YAHOO.util.Connect.asyncRequest(
			"POST",
			dialog.parent.wgScript,
			callback,
			'action=ajax&rs=WysiwygGetTemplateParamsAjax&rsargs[]=' + encodeURIComponent(templateName)
		);
	}
	return false;
}

// select template to be edited in step #2
function SelectTemplate(name, params) {
	FCK.log('editing template "'+name+'"');
	FCK.log(params);

	// if template has no parameters add it to article and close editor
	if (!params) {
		oEditor.FCKUndo.SaveUndoStep();

		FCK.Track('/templateEditor/save');
		FCK.InsertTemplate(origRefid, name, null);

		dialog.CloseDialog();
	}
	else {
		// fill wizard data and select step #2
		FCK.TemplateWizard = {'name': name, 'params': params, 'refid': origRefid};
		SelectStep(2);
	}
}

// change editor step
function SelectStep(stepId) {
	GetE('templateEditorStep1').style.display = (stepId == 1) ? 'block' : 'none';
	GetE('templateEditorStep2').style.display = (stepId == 2) ? 'block' : 'none';

	// show OK only in step #2
	dialog.SetOkButton( stepId==2 );

	currentStep = stepId;

	switch(stepId) {

		case 1:
			var templates = dialog.parent.templateHotList;
			var magicWords = dialog.parent.magicWordList;

			var templatesOutput = ['', '', ''];

			// generate two columns of "hot" templates
			var i = 0;
			for (name in templates) {
				templatesOutput[i%2] += '<li><a onclick="SelectTemplate(\'' + escape(name) + '\', dialog.parent.templateHotList.'+name+')">' + name + '</a></li>';
				i++;
			}

			// third column is for magic words ({{SITENAME}} etc)
			for (i=0; i<magicWords.length; i++) {
				var magicWord = magicWords[i].toUpperCase();
				templatesOutput[2] += '<li><a onclick="SelectTemplate(\'' + magicWord + '\', null)">' + magicWord + '</a></li>';
			}

			// set HTML
			GetE('templatesList1').innerHTML = templatesOutput[0];
			GetE('templatesList2').innerHTML = templatesOutput[1];
			GetE('templatesList3').innerHTML = templatesOutput[2];

			// setup MW suggest
			os_enableSuggestionsOn('templateQuery', 'templateSearch');
			break;


		case 2:
			name = (FCK.TemplateWizard.name.indexOf(':') > -1) ?  FCK.TemplateWizard.name : 'Template:' +  FCK.TemplateWizard.name;
			GetE('templateName').innerHTML = name; 

			GetE('templateViewLink').href = dialog.parent.wgServer + dialog.parent.wgArticlePath.replace(/\$1/, encodeURI(name.replace(/ /g, '_')));

			// generate params editor
			var output = '';

			for (param in FCK.TemplateWizard.params) {
				value = FCK.TemplateWizard.params[param];
				id = 'param_' + param;

				if (parseInt(param) > 0) {
					name = '<em>Parameter #' + param + '</em>';
				}
				else {
					name = param;
				}
				output += '<label for="'+id+'">'+name +'</label><textarea id="'+id+'"'+value+'</textarea>';
			}

			GetE('templateParameters').innerHTML = output;

			// focus on first textarea
			if (FCK.TemplateWizard.params) {
				GetE('templateParameters').getElementsByTagName('textarea')[0].focus();
			}

			// create preview
			CreatePreview();

			// disable MW suggest
			os_disableSuggestionsOn('templateQuery');
			break;
	}
}

// preview generation
//
function GetParametersFromStep2() {
	var params = {};

	// parameters name and value
	var nodes = GetE('templateParameters').getElementsByTagName('textarea');

	for(n=0; n<nodes.length; n++) {
		var name = nodes[n].id.substr(6);
		var value = nodes[n].value;

		params[name] = value;
	}

	return nodes.length ? params : null;
}

function GetWikitextFromStep2() {
	var wikitext = '';

	// template name
	wikitext = '{{' + GetE('templateName').innerHTML;

	// parameters name and value
	var params = GetParametersFromStep2();

	for(key in params) {
		var value = params[key];

		if (value == '') continue; // ignore empty parameters

		wikitext += '|' + key + '=' + value;
	}

	// close template markup
	wikitext += '}}';

	return wikitext;
}

function CreatePreview() {

	var wikitext = GetWikitextFromStep2();
	FCK.log('generating preview for >>' + wikitext + '<<');

	// block preview button and show progress icon
	GetE('templateDoPreview').disabled = true;
	GetE('templatePreview').innerHTML = '';
	GetE('templatePreview').className = 'progress';

	FCK.Track('/templateEditor/preview');

	var callback = {
		success: function(o) {
			result = eval('(' + o.responseText + ')');
			html = result.parse.text['*'];

			// remove newPP comment and whitespaces
			html = o.argument.FCK.YAHOO.lang.trim(html.split('<! \nNewPP limit report')[0]);

			// unblock preview button
			o.argument.preview.innerHTML = html;
			o.argument.preview.className = '';
			o.argument.button.disabled = false;

			// reset margin/padding/align
			o.argument.FCK.TemplatePreviewReset(o.argument.preview);
		},

		failure: function(o) {
			o.argument.preview.className = '';
			o.argument.button.disabled = false;
		},

		argument: {'preview': GetE('templatePreview'), 'button': GetE('templateDoPreview'), 'FCK': FCK}
	};

	FCK.YAHOO.util.Connect.asyncRequest(
		"POST",
		dialog.parent.wgScriptPath + '/api.php',
		callback,
		"action=parse&format=json&prop=text&title=" + encodeURIComponent(dialog.parent.wgPageName) + "&text=" +  encodeURIComponent(wikitext)
	);
}


function Ok() {

	// prevent clicking OK in step #1
	if (currentStep != 2) {
		return false;
	}

	oEditor.FCKUndo.SaveUndoStep();

	FCK.Track('/templateEditor/save');

	// insert / update template
	FCK.InsertTemplate(origRefid, FCK.TemplateWizard.name, GetParametersFromStep2());

	return true;
}
	</script>
	<style type="text/css">
		.progress {
			background: transparent url('../../../skins/default/images/progress_transparent.gif') no-repeat 50% 50%;
		}
	
		#template_preview p {
			margin: 0;
		}

		#template_preview * {
			cursor: default;
		}

		.resetTemplate {
			margin: 0 !important;
			padding: 0 !important;
			float: none !important;
			position: relative !important;
			top: 0px !important;
			left: auto !important;
			right: auto !important;
		}

		.editorStep {
			display: none;
			font-family: sans-serif !important;
		}

		.editorStep h1 {
			margin: 0;
			letter-spacing: -1px;
			font-size: 25px;
			font-weight: normal;
		}

		.editorStep h2 {
			margin: 0;
			font-size: 16px;
		}

		.editorStep h3 {
			font-weight: normal;
			margin: 0;
			line-height: 1.7em;
			padding-bottom: 10px;
			font-size: 13px;
			clear: both;
		}

		#templateName {
			float: left;
			margin-right: 25px;
		}

		#templateOptions {
			position: relative;
			top: 5px;
			font-size: 11px;
		}

		#templateOptions a {
			color: #0080C0;
			cursor: pointer;
			text-decoration: none;
			margin: 0 8px;
		}

		#templateParameters label {
			margin-top: 5px;
			font-size: 12px;
			display: block;
		}

		#templateParameters {
			height: 310px;
			overflow: auto;
		}

		#templateParameters textarea {
			border: solid 1px #666;
			width: 305px;
			height: 32px;
			font-family: monospace !important;
		}

		#templatePreview {		
			overflow: auto;
			height: 300px;
			background-color: #fff;
			border: solid 1px #666;
			font-size: 12px;
			padding: 3px;
		}


		#templateSearch {
			margin: 5px 0 5px 300px;
			padding: 4px;
		}

		#templateEditorStep1 hr {
			margin: 20px 0;
		}

		#templateEditorStep1 h2 {
			margin: 10px 0 5px 0;
		}

		#templateEditorStep1 ul {
			width: 245px;
			height: 150px;
			overflow: auto;
			float: left;
			display: inline;
			list-style: none;
			margin: 5px 0;
			padding: 0;
		}

		#templateEditorStep1 li {
			line-height: 2.25em;
			font-size: 13px;
		}

		#templateEditorStep1 a {
			cursor: pointer;
			color: #0080C0;
		}
	</style>
</head>
<body scroll="no" style="overflow: hidden">
	<div id="templateEditorStep1" class="editorStep">
		<h1 style="float: left">Search for Template</h1>
		
		<form id="templateSearch" onsubmit="InsertTemplateFromSearch()">
			<input type="text" id="templateQuery" style="width: 300px" />
			<input type="submit" value="Insert" />
		</form>

		<hr />

		<h1>Browse for Template</h1>

		<h2 style="float: left">Most Frequently Used</h2>
		<h2 style="float: right; width: 260px"><a href="http://help.wikia.com/wiki/Help:Magic_words" target="_blank">Magic words</a></h2>

		<br style="clear: both" />

		<ul class="templatesList" id="templatesList1"></ul>

		<ul class="templatesList" id="templatesList2"></ul>

		<ul class="templatesList" id="templatesList3"></ul>

		<br style="clear: both" />
	</div>

	<div id="templateEditorStep2" class="editorStep">
		<h1 id="templateName">Template</h1>
		<span id="templateOptions"><a id="templateViewLink" target="_blank">view template page (opens a new window)</a> <a onclick="SelectStep(1)">choose another template</a></span>
		<h3>Change the values on the left and click to preview. When you're done making your edits, click to save</h3>

		<table id="templateEditor" height="330px"><tr>

			<td width="330" height="330">
				<h2>Parameters</h2>
				<div id="templateParameters"></div>
			</td>
			<td>
				<input id="templateDoPreview" type="button" value="Preview" onclick="CreatePreview()" />
			</td>
			<td width="330">
				<h2>Preview</h2>
				<div id="templatePreview"></div>
			</td>
		</tr></table>
	</body>
</html>
