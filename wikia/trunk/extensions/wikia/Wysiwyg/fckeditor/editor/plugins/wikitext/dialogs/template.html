<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>Template Editor</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="robots" content="noindex, nofollow" />
	<script src="../../../dialog/common/fck_dialog_common.js" type="text/javascript"></script>
	<script type="text/javascript">
var dialog	= window.parent ;
var oEditor = dialog.InnerDialogLoaded() ;

var FCK			= oEditor.FCK ;
var FCKLang		= oEditor.FCKLang ;
var FCKConfig	= oEditor.FCKConfig ;
var FCKRegexLib	= oEditor.FCKRegexLib ;
var FCKTools	= oEditor.FCKTools ;

var currentStep = false;

window.onload = function() {
	window.parent.SetOkButton(true);
	window.parent.SetAutoSize(true);

	// fill editor fields

	// choose correct editor step
	FCK.log(FCK.TemplateWizard);

	if (FCK.TemplateWizard.name) {
		SelectStep(2);
	}
	else {
		SelectStep(1);
	}

	FCK.Track('/templateEditor/open');
}

// select template to be edited in step #2
function SelectTemplate(name, params) {
	FCK.log('editing template "'+name+'"');
	FCK.log(params);

	// if template has no parameters add it to article and close editor
	if (!params) {
		oEditor.FCKUndo.SaveUndoStep();

		FCK.Track('/templateEditor/save');
		FCK.InsertTemplate(-1, name, null);

		dialog.CloseDialog();
	}
	else {
		// fill wizard data and select step #2
		FCK.TemplateWizard = {'name': name, 'params': params, 'refid': -1};
		SelectStep(2);
	}
}

// change editor step
function SelectStep(stepId) {
	GetE('templateEditorStep1').style.display = (stepId == 1) ? 'block' : 'none';
	GetE('templateEditorStep2').style.display = (stepId == 2) ? 'block' : 'none';

	currentStep = stepId;

	switch(stepId) {

		case 1:
			var templates = dialog.parent.templateHotList;
			var templatesOutput = ['', ''];

			// generate two columns of "hot" templates
			var i = 0;
			for (name in templates) {
				templatesOutput[i%2] += '<li><a onclick="SelectTemplate(\'' + escape(name) + '\', dialog.parent.templateHotList.'+name+')">' + name + '</a></li>';
				i++;
			}

			// set HTML
			GetE('templatesList1').innerHTML = templatesOutput[0];
			GetE('templatesList2').innerHTML = templatesOutput[1];
			break;


		case 2:
			GetE('templateName').innerHTML = (FCK.TemplateWizard.name.indexOf(':') > -1) ?  FCK.TemplateWizard.name : 'Template:' +  FCK.TemplateWizard.name;

			var output = '';

			// generate params editor
			for (param in FCK.TemplateWizard.params) {
				value = FCK.TemplateWizard.params[param];
				id = 'param_' + param;

				if (parseInt(param) > 0) {
					name = '<em>Parameter #' + param + '</em>';
				}
				else {
					name = param;
				}
				output += '<label for="'+id+'">'+name +'</label><textarea id="'+id+'" rows="1">'+value+'</textarea>';
			}

			GetE('templateParameters').innerHTML = output;

			// focus on first textarea
			if (FCK.TemplateWizard.params) {
				GetE('templateParameters').getElementsByTagName('textarea')[0].focus();
			}

			// create preview
			CreatePreview();
			break;
	}
}

// preview generation
//
function GetParametersFromStep2() {
	var params = {};

	// parameters name and value
	var nodes = GetE('templateParameters').getElementsByTagName('textarea');

	for(n=0; n<nodes.length; n++) {
		var name = nodes[n].id.substr(6);
		var value = nodes[n].value;

		params[name] = value;
	}

	return nodes.length ? params : null;
}

function GetWikitextFromStep2() {
	var wikitext = '';

	// template name
	wikitext = '{{' + GetE('templateName').innerHTML;

	// parameters name and value
	var params = GetParametersFromStep2();

	for(key in params) {
		var value = params[key];

		if (value == '') continue; // ignore empty parameters

		wikitext += '|' + key + '=' + value;
	}

	// close template markup
	wikitext += '}}';

	return wikitext;
}

function CreatePreview() {

	var wikitext = GetWikitextFromStep2();
	FCK.log('generating preview for >>' + wikitext + '<<');

	// block preview button and show progress icon
	GetE('templateDoPreview').disabled = true;
	GetE('templatePreview').innerHTML = '';
	GetE('templatePreview').className = 'progress';

	FCK.Track('/templateEditor/preview');

	var callback = {
		success: function(o) {
			result = eval('(' + o.responseText + ')');
			html = result.parse.text['*'];

			// remove newPP comment and whitespaces
			html = o.argument.FCK.YAHOO.lang.trim(html.split('<! \nNewPP limit report')[0]);

			// unblock preview button
			o.argument.preview.innerHTML = html;
			o.argument.preview.className = '';
			o.argument.button.disabled = false;

			// reset margin/padding/align
			o.argument.FCK.TemplatePreviewReset(o.argument.preview);
		},

		failure: function(o) {
			o.argument.preview.className = '';
			o.argument.button.disabled = false;
		},

		argument: {'preview': GetE('templatePreview'), 'button': GetE('templateDoPreview'), 'FCK': FCK}
	};

	FCK.YAHOO.util.Connect.asyncRequest(
		"POST",
		dialog.parent.wgScriptPath + '/api.php',
		callback,
		"action=parse&format=json&prop=text&title=" + encodeURIComponent(dialog.parent.wgPageName) + "&text=" +  encodeURIComponent(wikitext)
	);
}


function Ok() {

	// disallow clicks on "Ok" when step #1 is active
	if (currentStep == 1) {
		return false;
	}
	
	oEditor.FCKUndo.SaveUndoStep();

	FCK.Track('/templateEditor/save');

	// insert / update template
	FCK.InsertTemplate(FCK.TemplateWizard.refid, FCK.TemplateWizard.name, GetParametersFromStep2());

	return true;
}
	</script>
	<style type="text/css">
		.progress {
			background: transparent url('../../../skins/default/images/progress_transparent.gif') no-repeat 50% 50%;
		}
	
		#template_preview p {
			margin: 0;
		}

		#template_preview * {
			cursor: default;
		}

		.resetTemplate {
			margin: 0 !important;
			padding: 0 !important;
			float: none !important;
		}

		.editorStep {
			display: none;
		}

		.editorStep h1 {
			margin: 0;
			letter-spacing: -1px;
			font-size: 25px;
			font-weight: normal;
		}

		.editorStep h2 {
			margin: 0;
			font-size: 16px;
		}

		.editorStep h3 {
			font-weight: normal;
			margin: 0;
			line-height: 1.7em;
			padding-bottom: 10px;
			font-size: 13px;
		}

		#templateParameters label {
			margin-top: 5px;
			font-size: 12px;
			display: block;
		}

		#templateParameters {
			height: 310px;
			overflow: auto;
		}

		#templateParameters textarea {
			border: solid 1px #666;
			width: 305px;
		}

		#templatePreview {		
			overflow: auto;
			height: 300px;
			background-color: #fff;
			border: solid 1px #666;
			font-size: 12px;
			padding: 3px;
		}


		#templateSearch {
			margin: 5px 0 5px 300px;
			padding: 4px;
		}

		#templateEditorStep1 hr {
			margin: 20px 0;
		}

		#templateEditorStep1 h2 {
			margin: 10px 0 5px 0;
		}

		#templateEditorStep1 ul {
			width: 360px;
			float: left;
			display: inline;
			list-style: none;
			margin: 0;
			padding: 0;
		}

		#templateEditorStep1 li {
			line-height: 2em;
			font-size: 13px;
		}

		#templateEditorStep1 li a {
			cursor: pointer;
			color: #0080C0;
		}
	</style>
</head>
<body scroll="no" style="overflow: hidden">
	<div id="templateEditorStep1" class="editorStep">
		<h1 style="float: left">Search for Template</h1>
		
		<form id="templateSearch">
			<input type="text" id="templateQuery" style="width: 300px" />
			<input type="submit" value="Insert" />
		</form>

		<hr />

		<h1>Browse for Template</h1>
		<h2>Most Frequently Used</h2>

		<ul class="templatesList" id="templatesList1"></ul>

		<ul class="templatesList" id="templatesList2"></ul>

		<br style="clear: both" />
	</div>

	<div id="templateEditorStep2" class="editorStep">
		<h1 id="templateName">Template</h1>
		<h3>Change the values on the left and click to preview. When you're done making your edits, click to save</h3>

		<table id="templateEditor" height="330px"><tr>

			<td width="330" height="330">
				<h2>Parameters</h2>
				<div id="templateParameters"></div>
			</td>
			<td>
				<input id="templateDoPreview" type="button" value="Preview" onclick="CreatePreview()" />
			</td>
			<td width="330">
				<h2>Preview</h2>
				<div id="templatePreview"></div>
			</td>
		</tr></table>
	</body>
</html>
