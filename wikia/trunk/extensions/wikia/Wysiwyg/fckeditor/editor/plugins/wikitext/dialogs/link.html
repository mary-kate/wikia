<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title>Link Properties</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="robots" content="noindex, nofollow" />
	<script src="../../../dialog/common/fck_dialog_common.js" type="text/javascript"></script>
	<script type="text/javascript">
var dialog	= window.parent ;
var oEditor = dialog.InnerDialogLoaded() ;

var FCK			= oEditor.FCK ;
var FCKLang		= oEditor.FCKLang ;
var FCKConfig	= oEditor.FCKConfig ;
var FCKRegexLib	= oEditor.FCKRegexLib ;
var FCKTools	= oEditor.FCKTools ;

// Overall classification
var EXISTING = 1;
var NEW_SELECTION = 2;
var NEW_NO_SELECTION = 3;
var MODE;

// In detail classification for EXISTING
var INTERNAL = 4;
var EXTERNAL = 5;
var TYPE = INTERNAL;

var activeTabCode;

var link = dialog.Selection.GetSelection().MoveToAncestorNode('A');

// Determine link MODE and TYPE. Also if it's existing link then expand editor selection.
if(link) {
	var refid = link.getAttribute('refid');
	FCK.Selection.SelectNode(link);
	var data = FCK.wysiwygData[link.getAttribute('refid')];

	MODE = EXISTING;
	if(data.type == 'internal link') {
		TYPE = INTERNAL;
	} else {
		TYPE = EXTERNAL;
	}

} else {

	var selection = FCK.Selection.GetSelection();
	var selectionText = selection.type ? selection.createRange().text : selection.toString();
	if(selectionText != '') {
		MODE = NEW_SELECTION;
	} else {
		MODE = NEW_NO_SELECTION;
	}

}

dialog.AddTab('internal_link', 'Internal link');
dialog.AddTab('external_link', 'External link');

function OnDialogTabChange(tabCode) {
	ShowE('divInternalLink', (tabCode == 'internal_link'));
	ShowE('divExternalLink', (tabCode == 'external_link'));
	if(tabCode == 'internal_link') {
		if(GetE('internal_link_text').value == '') {
			GetE('internal_link_text').value = GetE('external_link_text').value;
		}
	} else if(tabCode == 'external_link') {
		if(GetE('external_link_text').value == '') {
			GetE('external_link_text').value = GetE('internal_link_text').value;
		}
	}
	activeTabCode = tabCode;
	dialog.SetAutoSize( true ) ;
}

window.onload = function() {

	GetE('external_unlabeled_link').onchange = function() {
		GetE('external_link_text').disabled = GetE('external_unlabeled_link').checked;
	}

	if(MODE == EXISTING) {

		if(TYPE == INTERNAL) {

			dialog.SetSelectedTab('internal_link');

			GetE('internal_article_name').value = FCK.wysiwygData[refid].href;

			if(GetE('internal_article_name').value != link.innerHTML) {
				GetE('internal_link_text').value = link.innerHTML;
			}

		} else if(TYPE == EXTERNAL) {

			dialog.SetSelectedTab('external_link');

			GetE('external_url').value = FCK.wysiwygData[refid].href;

			if(link.innerHTML == '[link]') { // TODO:
				GetE('external_link_text').disabled = true;
				GetE('external_unlabeled_link').checked = true;
			} else {
				if(GetE('external_url').value != link.innerHTML) {
					GetE('external_link_text').value = link.innerHTML;
				}
			}

		}

	} else { // NEW LINKS

		dialog.SetSelectedTab('internal_link');

		if(MODE == NEW_SELECTION) {
			GetE('internal_article_name').value = selectionText;
		}

	}

	window.parent.SetOkButton(true);
	window.parent.SetAutoSize(true);
}

function Ok() {
	oEditor.FCKUndo.SaveUndoStep();

	if(MODE == EXISTING) {
		var aLinks = [link];
	} else {
		if(MODE == NEW_SELECTION) {
			var aLinks = oEditor.FCK.CreateLink(' ', true);
		} else if(MODE == NEW_NO_SELECTION) {
			var aLinks = [oEditor.FCK.InsertElement('a')];
		}
	}

	var data = {};

	var link_text;

	if(activeTabCode == 'internal_link') {
		link_text = GetE('internal_link_text').value;
		if(link_text == '') {
			link_text = GetE('internal_article_name').value;
			if(link_text.substring(0,1) == ':') {
				link_text = link_text.substring(1);
			}
		}
		data.type = 'internal link';
		data.href = GetE('internal_article_name').value;
	} else if(activeTabCode == 'external_link') {
		if(GetE('external_link_text').disabled != true && GetE('external_link_text').value != '') {
			link_text = GetE('external_link_text').value;
			data.type = 'external link';
		} else if(GetE('external_link_text').disabled != true) {
			link_text = GetE('external_url').value;
			data.type = 'external link: raw';
		} else {
			link_text = '[link]';
			data.type = 'external link';
		}
		data.href = GetE('external_url').value;
	}

	aLinks[0].innerHTML = link_text;
	aLinks[0].href = '';

	if(!refid) {
		refid = FCK.wysiwygData.length;
		aLinks[0].setAttribute('refid', refid);
	}

	FCK.wysiwygData[refid] = data;

	return true;
}
	</script>
</head>
	<body scroll="no" style="OVERFLOW: hidden">
		<div id="divInternalLink" style="DISPLAY: none">

			<span>Article name:</span>
			<br />
			<input id="internal_article_name" style="WIDTH: 100%" type="text" />

			<br /><br />

			<span>Link text (if different than Article name):</span>
			<br />
			<input id="internal_link_text" style="WIDTH: 100%" type="text" />

		</div>

		<div id="divExternalLink" style="DISPLAY: none">

			<span>URL:</span>
			<br />
			<input id="external_url" style="WIDTH: 100%" type="text" />

			<br /><br />

			<span>Link text (if different than URL):</span>
			<br />
			<input id="external_link_text" style="WIDTH: 100%" type="text" />

			<br /><br />

			<input id="external_unlabeled_link" type="checkbox" />
			<label for="external_unlabeled_link">Unlabeled link</label>

		</div>

	</body>
</html>