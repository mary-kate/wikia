<!DOCTYPE html
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!--
This file was generated by Devel::Cover Version 0.64
Devel::Cover is copyright 2001-2006, Paul Johnson (pjcj@cpan.org)
Devel::Cover is free. It is licensed under the same terms as Perl itself.
The latest version of Devel::Cover should be available from my homepage:
http://www.pjcj.net
-->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta>
    <meta http-equiv="Content-Language" content="en-us"></meta>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <link rel="stylesheet" type="text/css" href="cover.css"></link>
    <title>File Coverage: blib/lib/GlbDNS/Zone.pm</title>
</head>
<body>
<h1>File Coverage</h1>
<table>
<tr><td class="h" align="right">File:</td><td align="left">blib/lib/GlbDNS/Zone.pm</td></tr>
<tr><td class="h" align="right">Coverage:</td><td align="left" class="c3">100.0%</td></tr>
</table>
<div><br/></div>
<table>
<tr><th>line</th><th>stmt</th><th>bran</th><th>cond</th><th>sub</th><th>pod</th><th>time</th><th>code</th></tr>
<tr><td class="h">1</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">package GlbDNS::Zone;</td></tr>
<tr><td class="h">2</td><td colspan="7"></td></tr><tr><td class="h">3</td><td colspan="7"></td></tr><tr><td class="h">4</td><td><div class="c3">20</div><div class="c3">20</div><div class="c3">20</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L4">20</a></div></td><td></td><td><div>83</div><div>32</div><div>142</div></td><td class="s">use strict;</td></tr>
<tr><td class="h">5</td><td><div class="c3">20</div><div class="c3">20</div><div class="c3">20</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L5">20</a></div></td><td></td><td><div>118</div><div>44</div><div>143</div></td><td class="s">use warnings;</td></tr>
<tr><td class="h">6</td><td><div class="c3">20</div><div class="c3">20</div><div class="c3">20</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L6">20</a></div></td><td></td><td><div>101</div><div>33</div><div>207</div></td><td class="s">use Data::Dumper;</td></tr>
<tr><td class="h">7</td><td><div class="c3">20</div><div class="c3">20</div><div class="c3">20</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L7">20</a></div></td><td></td><td><div>20101</div><div>47</div><div>258</div></td><td class="s">use Net::DNS::RR::A;</td></tr>
<tr><td class="h">8</td><td colspan="7"></td></tr><tr><td class="h">9</td><td colspan="7"></td></tr><tr><td class="h">10 - 19</td><td colspan="6"></td><td class="s"><pre>=head1 GlbDNS::Zone

Parsing zone files with LOC data

=head2 load_configs

    GlbDNS-&gt;load_configs($glbdns, $path);
    GlbDNS-&gt;load_configs($glbdns, $file);

=cut</pre></td></tr>
<tr><td class="h">20</td><td colspan="7"></td></tr><tr><td class="h">21</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub load_configs {</td></tr>
<tr><td class="h">22</td><td><div class="c3">62</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L22">62</a></div></td><td><div class="c3">1</div></td><td><div>1565</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">23</td><td><div class="c3">62</div></td><td></td><td></td><td></td><td></td><td><div>178</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $glbdns = shift;</td></tr>
<tr><td class="h">24</td><td><div class="c3">62</div></td><td></td><td></td><td></td><td></td><td><div>182</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $path = shift;</td></tr>
<tr><td class="h">25</td><td><div class="c3">62</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L25">100</a></div><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L25">100</a></div></td><td></td><td></td><td></td><td><div>8395</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;if (-d $path) {</td></tr>
<tr><td class="h">26</td><td><div class="c3">12</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L26">100</a></div></td><td></td><td></td><td></td><td><div>401</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;opendir(DIR, $path) || die &quot;Cannot open directory &#39;$path&#39;: $!\n&quot;;</td></tr>
<tr><td class="h">27</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>2317</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for my $file (readdir(DIR)) {</td></tr>
<tr><td class="h">28</td><td><div class="c3">56</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L28">100</a></div></td><td></td><td></td><td></td><td><div>565</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if (-d $file);</td></tr>
<tr><td class="h">29</td><td><div class="c3">35</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L29">100</a></div></td><td></td><td></td><td></td><td><div>191</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ($file =~/^(\.|#)/);</td></tr>
<tr><td class="h">30</td><td><div class="c3">21</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L30">100</a></div></td><td></td><td></td><td></td><td><div>141</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if ($file =~/~$/);</td></tr>
<tr><td class="h">31</td><td><div class="c3">7</div></td><td></td><td></td><td></td><td></td><td><div>109</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$class-&gt;parse($glbdns, &quot;$path/$file&quot;);</td></tr>
<tr><td class="h">32</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">33</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} elsif (-f $path) {</td></tr>
<tr><td class="h">34</td><td><div class="c3">45</div></td><td></td><td></td><td></td><td></td><td><div>3112</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$class-&gt;parse($glbdns, $path);</td></tr>
<tr><td class="h">35</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">36</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>8</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Cannot find zone &#39;$path&#39;\n&quot;;</td></tr>
<tr><td class="h">37</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">38</td><td><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>482</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;$class-&gt;geo_fix($glbdns);</td></tr>
<tr><td class="h">39</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">40</td><td colspan="7"></td></tr><tr><td class="h">41 - 45</td><td colspan="6"></td><td class="s"><pre>=head2 parse

    GlbDNS-&gt;parse($glbdns, $file);

=cut</pre></td></tr>
<tr><td class="h">46</td><td colspan="7"></td></tr><tr><td class="h">47</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub parse {</td></tr>
<tr><td class="h">48</td><td><div class="c3">52</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L48">52</a></div></td><td><div class="c3">1</div></td><td><div>217</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">49</td><td><div class="c3">52</div></td><td></td><td></td><td></td><td></td><td><div>160</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $glbdns = shift;</td></tr>
<tr><td class="h">50</td><td><div class="c3">52</div></td><td></td><td></td><td></td><td></td><td><div>781</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $file = shift;</td></tr>
<tr><td class="h">51</td><td colspan="7"></td></tr><tr><td class="h">52</td><td><div class="c3">52</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L52">100</a></div></td><td></td><td></td><td></td><td><div>2019</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;open(my $fh, &quot;&lt;&quot;, &quot;$file&quot;) || die &quot;Cannot open file &#39;$file&#39;: $!\n&quot;;</td></tr>
<tr><td class="h">53</td><td><div class="c3">47</div><div class="c3">47</div></td><td></td><td></td><td></td><td></td><td><div>123</div><div>790</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $mtime = @{[stat(&quot;$file&quot;)]}[9];</td></tr>
<tr><td class="h">54</td><td colspan="7"></td></tr><tr><td class="h">55</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $error = sub {</td></tr>
<tr><td class="h">56</td><td><div class="c3">10</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L56">10</a></div></td><td></td><td><div>20</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;$_[0] at $file:$.\n&quot;;</td></tr>
<tr><td class="h">57</td><td><div class="c3">47</div></td><td></td><td></td><td></td><td></td><td><div>532</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;};</td></tr>
<tr><td class="h">58</td><td colspan="7"></td></tr><tr><td class="h">59</td><td colspan="7"></td></tr><tr><td class="h">60</td><td colspan="7"></td></tr><tr><td class="h">61</td><td><div class="c3">47</div></td><td></td><td></td><td></td><td></td><td><div>81</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $base_fqdn;</td></tr>
<tr><td class="h">62</td><td><div class="c3">47</div></td><td></td><td></td><td></td><td></td><td><div>105</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $base;</td></tr>
<tr><td class="h">63</td><td><div class="c3">47</div></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L63">100</a></div></td><td></td><td></td><td><div>383</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hosts = $glbdns-&gt;{hosts} ||= {};</td></tr>
<tr><td class="h">64</td><td><div class="c3">47</div></td><td></td><td></td><td></td><td></td><td><div>3758</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;while(my $line = &lt;$fh&gt;) {</td></tr>
<tr><td class="h">65</td><td><div class="c3">1155</div></td><td></td><td></td><td></td><td></td><td><div>2170</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;chomp($line);</td></tr>
<tr><td class="h">66</td><td><div class="c3">1155</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L66">100</a></div></td><td></td><td></td><td></td><td><div>5578</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next unless($line);</td></tr>
<tr><td class="h">67</td><td><div class="c3">743</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L67">100</a></div></td><td></td><td></td><td></td><td><div>4756</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if($line =~ /^\s+$/);</td></tr>
<tr><td class="h">68</td><td><div class="c3">726</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L68">100</a></div></td><td></td><td></td><td></td><td><div>3896</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next if($line =~ /^;/);</td></tr>
<tr><td class="h">69</td><td colspan="7"></td></tr><tr><td class="h">70</td><td><div class="c3">641</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L70">100</a></div><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L70">100</a></div></td><td></td><td></td><td></td><td><div>6958</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($line =~/\$ORIGIN\s+([a-zA-Z.\-]+)/) {</td></tr>
<tr><td class="h">71</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>217</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$base_fqdn = $1;</td></tr>
<tr><td class="h">72</td><td><div class="c3">42</div></td><td></td><td></td><td></td><td></td><td><div>264</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;($base) = $base_fqdn =~/(.*)\.$/;</td></tr>
<tr><td class="h">73</td><td><div class="c3">42</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L73">100</a></div></td><td></td><td></td><td></td><td><div>202</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error-&gt;(&quot;&#39;$base_fqdn&#39; needs to be terminated with a . to be a FQDN&quot;) unless ($base);</td></tr>
<tr><td class="h">74</td><td><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>174</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next;</td></tr>
<tr><td class="h">75</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} elsif (!$base) {</td></tr>
<tr><td class="h">76</td><td><div class="c3">5</div></td><td></td><td></td><td></td><td></td><td><div>19</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$error-&gt;(&quot;No \$ORIGIN domain has been specified, don&#39;t know what domain we are working on&quot;);</td></tr>
<tr><td class="h">77</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">78</td><td colspan="7"></td></tr><tr><td class="h">79</td><td><div class="c3">594</div></td><td></td><td></td><td></td><td></td><td><div>4555</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @record = split /\s+/, $line;</td></tr>
<tr><td class="h">80</td><td colspan="7"></td></tr><tr><td class="h">81</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# if the first record is a DNS entry</td></tr>
<tr><td class="h">82</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# then check if it is a FQDN and complete it</td></tr>
<tr><td class="h">83</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# or use the default one</td></tr>
<tr><td class="h">84</td><td><div class="c3">594</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L84">100</a></div></td><td></td><td></td><td></td><td><div>5484</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($record[0] !~ /^\d+$/) {</td></tr>
<tr><td class="h">85</td><td><div class="c3">450</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L85">100</a></div></td><td></td><td></td><td></td><td><div>3022</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record[0] = &quot;$record[0].$base&quot; if($record[0] !~ /\.$/);</td></tr>
<tr><td class="h">86</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} else {</td></tr>
<tr><td class="h">87</td><td><div class="c3">144</div></td><td></td><td></td><td></td><td></td><td><div>480</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unshift @record, $base;</td></tr>
<tr><td class="h">88</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">89</td><td colspan="7"></td></tr><tr><td class="h">90</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fully qualify CNAMEs</td></tr>
<tr><td class="h">91</td><td><div class="c3">594</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L91">100</a></div></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L91">100</a></div></td><td></td><td></td><td><div>8372</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($record[3] eq &#39;CNAME&#39; &amp;&amp; $record[4] !~/\.$/) {</td></tr>
<tr><td class="h">92</td><td><div class="c3">145</div></td><td></td><td></td><td></td><td></td><td><div>507</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record[4] .= &quot;.$base&quot;;</td></tr>
<tr><td class="h">93</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">94</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# fully qualify MX</td></tr>
<tr><td class="h">95</td><td><div class="c3">594</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L95">100</a></div></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L95">100</a></div></td><td></td><td></td><td><div>4185</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($record[3] eq &#39;MX&#39; &amp;&amp; $record[5] !~/\.$/) {</td></tr>
<tr><td class="h">96</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>73</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$record[5] .= &quot;.$base&quot;;</td></tr>
<tr><td class="h">97</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">98</td><td colspan="7"></td></tr><tr><td class="h">99</td><td><div class="c3">594</div></td><td></td><td></td><td></td><td></td><td><div>7091</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $rr = Net::DNS::RR-&gt;new(join &quot; &quot;, @record);</td></tr>
<tr><td class="h">100</td><td colspan="7"></td></tr><tr><td class="h">101</td><td><div class="c3">594</div></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L101">100</a></div></td><td></td><td></td><td><div>24048</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $host = $hosts-&gt;{$rr-&gt;name} ||= {};</td></tr>
<tr><td class="h">102</td><td colspan="7"></td></tr><tr><td class="h">103</td><td><div class="c3">594</div></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L103">100</a></div></td><td></td><td></td><td><div>41013</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $records = $host-&gt;{$rr-&gt;type} ||= [];</td></tr>
<tr><td class="h">104</td><td colspan="7"></td></tr><tr><td class="h">105</td><td><div class="c3">594</div></td><td></td><td></td><td></td><td></td><td><div>31228</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$host-&gt;{__RECORD__} = $rr-&gt;name;</td></tr>
<tr><td class="h">106</td><td><div class="c3">594</div></td><td></td><td></td><td></td><td></td><td><div>21408</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$host-&gt;{domain} = $host-&gt;{__DOMAIN__} = $base;</td></tr>
<tr><td class="h">107</td><td colspan="7"></td></tr><tr><td class="h">108</td><td colspan="7"></td></tr><tr><td class="h">109</td><td><div class="c3">594</div></td><td></td><td></td><td></td><td></td><td><div>6876</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push @$records, $rr;</td></tr>
<tr><td class="h">110</td><td colspan="7"></td></tr><tr><td class="h">111</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">112</td><td><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>94</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;close($fh);</td></tr>
<tr><td class="h">113</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">114</td><td colspan="7"></td></tr><tr><td class="h">115 - 119</td><td colspan="6"></td><td class="s"><pre>=head2 geo_fix

   GlbDNS::Zone-&gt;geo_fix($glbdns);

=cut</pre></td></tr>
<tr><td class="h">120</td><td colspan="7"></td></tr><tr><td class="h">121</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">sub geo_fix {</td></tr>
<tr><td class="h">122</td><td><div class="c3">37</div></td><td></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--subroutine.html#L122">37</a></div></td><td><div class="c3">1</div></td><td><div>132</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $class = shift;</td></tr>
<tr><td class="h">123</td><td><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>115</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $glbdns = shift;</td></tr>
<tr><td class="h">124</td><td><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>139</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;my $hosts = $glbdns-&gt;{hosts};</td></tr>
<tr><td class="h">125</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;# now go through and fix up the geolocation ones</td></tr>
<tr><td class="h">126</td><td><div class="c3">37</div><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>78</div><div>252</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;foreach my $host (values %{$hosts}) {</td></tr>
<tr><td class="h">127</td><td><div class="c3">266</div><div class="c3">88</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L127">100</a></div></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L127">100</a></div></td><td></td><td></td><td><div>1456</div><div>697</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($host-&gt;{CNAME} &amp;&amp; @{$host-&gt;{CNAME}} &gt; 1) {</td></tr>
<tr><td class="h">128</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# more than one cname is not allowed</td></tr>
<tr><td class="h">129</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# so they have to point to geo tagged records</td></tr>
<tr><td class="h">130</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;# or we abort</td></tr>
<tr><td class="h">131</td><td><div class="c3">37</div><div class="c3">37</div></td><td></td><td></td><td></td><td></td><td><div>99</div><div>187</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $cname (@{$host-&gt;{CNAME}}) {</td></tr>
<tr><td class="h">132</td><td><div class="c3">76</div></td><td></td><td></td><td></td><td></td><td><div>519</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $target = $hosts-&gt;{$cname-&gt;cname};</td></tr>
<tr><td class="h">133</td><td><div class="c3">76</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L133">100</a></div></td><td></td><td></td><td></td><td><div>4630</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Need record for &quot; . $cname-&gt;cname . &quot;\n&quot; unless $target;</td></tr>
<tr><td class="h">134</td><td><div class="c3">71</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L134">100</a></div></td><td></td><td></td><td></td><td><div>338</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Record &quot; . $cname-&gt;name . &quot; needs LOC data\n&quot; unless $target-&gt;{LOC};</td></tr>
<tr><td class="h">135</td><td colspan="7"></td></tr><tr><td class="h">136</td><td><div class="c3">66</div></td><td></td><td></td><td></td><td></td><td><div>367</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my ($lat, $lon) = $target-&gt;{LOC}[0]-&gt;latlon;</td></tr>
<tr><td class="h">137</td><td><div class="c3">66</div></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L137">100</a></div></td><td></td><td></td><td><div>1981</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $geo = $host-&gt;{__GEO__} ||= {};</td></tr>
<tr><td class="h">138</td><td colspan="7"></td></tr><tr><td class="h">139</td><td><div class="c3">66</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L139">100</a></div></td><td></td><td></td><td></td><td><div>309</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die &quot;Trying to overwrite geo target $target-&gt;{__RECORD__}\n&quot; if($geo-&gt;{$target-&gt;{__RECORD__}});</td></tr>
<tr><td class="h">140</td><td><div class="c3">61</div></td><td></td><td></td><td></td><td></td><td><div>291</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my $geo_entry = $geo-&gt;{$target-&gt;{__RECORD__}} = {};</td></tr>
<tr><td class="h">141</td><td colspan="7"></td></tr><tr><td class="h">142</td><td><div class="c3">61</div></td><td></td><td></td><td></td><td></td><td><div>283</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$geo_entry-&gt;{lat} = $lat;</td></tr>
<tr><td class="h">143</td><td><div class="c3">61</div></td><td></td><td></td><td></td><td></td><td><div>182</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$geo_entry-&gt;{lon} = $lon;</td></tr>
<tr><td class="h">144</td><td><div class="c3">61</div></td><td></td><td><div class="c3"><a href="blib-lib-GlbDNS-Zone-pm--condition.html#L144">100</a></div></td><td></td><td></td><td><div>2806</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$geo_entry-&gt;{hosts} = $target-&gt;{A} || $target-&gt;{CNAME} || die &quot;Need A or CNAME for $target-&gt;{__RECORD__}\n&quot;;</td></tr>
<tr><td class="h">145</td><td><div class="c3">56</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L145">100</a></div></td><td></td><td></td><td></td><td><div>224</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ($target-&gt;{TXT}) {</td></tr>
<tr><td class="h">146</td><td><div class="c3">27</div><div class="c3">27</div></td><td></td><td></td><td></td><td></td><td><div>52</div><div>134</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach my $txt (@{$target-&gt;{TXT}}) {</td></tr>
<tr><td class="h">147</td><td><div class="c3">27</div></td><td></td><td></td><td></td><td></td><td><div>120</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;my @txt = $txt-&gt;char_str_list;</td></tr>
<tr><td class="h">148</td><td><div class="c3">27</div></td><td><div class="c3" title="T/F"><a href="blib-lib-GlbDNS-Zone-pm--branch.html#L148">100</a></div></td><td></td><td></td><td></td><td><div>152</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($txt[0] eq &#39;GlbDNS::RADIUS&#39;) {</td></tr>
<tr><td class="h">149</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>118</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$geo_entry-&gt;{radius} = $txt[1];</td></tr>
<tr><td class="h">150</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">151</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">152</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">153</td><td><div class="c3">56</div></td><td></td><td></td><td></td><td></td><td><div>379</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$geo_entry-&gt;{source}-&gt;{$host-&gt;{__RECORD__}} = $cname;</td></tr>
<tr><td class="h">154</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">155</td><td><div class="c3">17</div></td><td></td><td></td><td></td><td></td><td><div>162</div></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete($host-&gt;{CNAME});</td></tr>
<tr><td class="h">156</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">157</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">&nbsp;&nbsp;&nbsp;&nbsp;}</td></tr>
<tr><td class="h">158</td><td colspan="7"></td></tr><tr><td class="h">159</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">}</td></tr>
<tr><td class="h">160</td><td colspan="7"></td></tr><tr><td class="h">161</td><td colspan="7"></td></tr><tr><td class="h">162</td><td></td><td></td><td></td><td></td><td></td><td></td><td class="s">1;</td></tr>
</table>
</body>
</html>
